name: Azure Pipelines

# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml
trigger:
- main

# ToDo: Replace the agent pool name, if you are using Udacity Cloud lab. 
# Otherwise, comment out the line below. 
pool: myAgentPool

variables:
  python.version: '3.9.24'  #'3.7.6'
  # ToDo: Replace the service connection name as used in the DevOps project settings
  azureServiceConnectionId: 'myServiceConnection'
  # Project root folder. Point to the folder containing manage.py file.
  projectRoot: $(System.DefaultWorkingDirectory)
  # Environment name
  environmentName: 'test-vm'   
  # Web app name
  webAppName: 'myAppli3-AppService' 
  # chromedriver version
  chromedriverVersion: '142.0.7444.59'
  # userAgent
  userAgent : 'devopsagent'



stages:
#--------------------------------------------#  
# BUILD STAGE
#--------------------------------------------#    
- stage: Build
  jobs:
  - job: BuildInfrastructure
    steps:
    #--------------------------------------------#  
    # Use Terraform to create the Infrastructure      
    # Install Terraform on the pipeline agent 
    - task: ms-devlabs.custom-terraform-tasks.custom-terraform-installer-task.TerraformInstaller@0
      displayName: 'Terrafom installation'
      inputs:
        terraformVersion: '1.2.9'
    
    # Run Terraform Init on the pipeline agent 
    # ToDo: Replace the resource group name, storage account name, and container name below
    

  
#--------------------------------------------#
    # Selenium (UI) Test Suite - Archive the package  
    # "ArchiveFiles@2" picks up the web package and archives it.
    - task: ArchiveFiles@2
      displayName: 'Archive UI Tests'
      inputs:
        rootFolderOrFile: '$(System.DefaultWorkingDirectory)/automatedtesting/selenium'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId)-uitests.zip'
    # Selenium Test Suite - Publish the package  
    - publish: $(Build.ArtifactStagingDirectory)/$(Build.BuildId)-uitests.zip   # Same as the archiveFile artifact above. 
      displayName: 'Upload Package uitests'
      artifact: drop-uitests

     
   

#--------------------------------------------#  
# DEPLOYMENT STAGE
#--------------------------------------------#    
- stage: Deploy
  jobs:
  #--------------------------------------------#  
  # Deploy FakeRestAPI Web App
  # ToDo: Provide <environment name> you created in your DevOps project

              
  #--------------------------------------------#  
  # Selenium | Functional UI Tests
  # ToDo: 
  - deployment: VMDeploy
    displayName: Selenium Tests
    environment:
      name:  "$(environmentName)"       # ToDo: Change/provide a name
      resourceType: VirtualMachine
      tags: selenium   
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: drop-uitests     # ToDo: Change/provide a name
            
          - task: Bash@3
            inputs:
              targetType: 'inline'
              script: |      
                #! /bin/bash

                # NEW version 142.0.7444.59
                echo "Step 1: Install pip, unzip"
                sudo apt update && sudo apt upgrade -y 
                sudo apt-get install python3-pip -y
                sudo apt-get install unzip -y

                which python3
                python3 --version
                echo $PATH
                
                echo "Step 2: Install Google-chrome"
                #pwd
                #wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
                #sudo apt install -f ./google-chrome-stable_current_amd64.deb -y
                google-chrome --version
                
                echo "Step 3: Install selenium"
                pip3 install selenium

                PATH=$PATH:"~/.local/bin"
                echo "PATH after install selenium is: $PATH"
                pip show selenium

                echo "Step 4: Install chromedriver in app folder"
                DIR=/home/testuser/app
                if [ ! -d "$DIR" ]; then 
                    mkdir $DIR
                fi
                
                cd $DIR
                #FILE=/home/testuser/app/chromedriver_linux64.zip 
                echo "FILE verified is $FILE"
                FILE=/$DIR/chromedriver_linux64.zip 
                if [! -f "$FILE" ]; then
                  wget https://storage.googleapis.com/chrome-for-testing-public/142.0.7444.59/linux64/chromedriver-linux64.zip
                  unzip -o ./chromedriver-linux64.zip
                  #sudo ln -s $PWD/chromedriver /usr/local/bin/chromedriver
                  #sudo ln -s $DIR/chromedriver /usr/local/bin/chromedriver
                fi

                echo "Step 5: Copy selenium tests into app folder"
                cd $DIR
                ls -la
                cp /home/testuser/azagent/_work/1/drop-uitests/$(Build.BuildId)-uitests.zip $DIR
                unzip -o $(Build.BuildId)-uitests.zip

                #export PATH=$PATH:/home/testuser/app
                export PATH=$PATH:$DIR

                echo "Step 6: Execute selenium tests"
                echo "Starting Selenium Tests"

                chromedriver -v
                google-chrome --version
                which chromedriver
                echo "PATH is $PATH"

                cd $DIR
                pwd
                ls -la
                python3 add_remove_from_cart.py | tee -a selenium.log
                
                ls -la
                file -bi selenium.log
                echo "Before cat command"
                cat selenium.log
                echo "After cat command"
                
                echo "Completed Selenium Tests. Check selenium.log for results."

